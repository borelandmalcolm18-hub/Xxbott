
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deriv Dual-Mode Bot</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
.container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
input, select, button { margin: 5px; padding: 6px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #eee; }
.safe { color: green; font-weight: bold; }
.unsafe { color: red; font-weight: bold; }
</style>
</head>
<body>
<div class="container">
<h1>Deriv Dual-Mode Bot</h1>
<div>
<label>Mode:</label>
<select id="mode">
<option value="simulation">Simulation</option>
<option value="live">Live Trading</option>
</select>
</div>
<div id="live-settings" style="display:none;">
<label>App ID:</label><input id="appId" type="text">
<label>Token:</label><input id="token" type="text">
<button onclick="connectDeriv()">Connect</button>
</div>
<div>
<label>Index:</label>
<select id="index">
<option value="R_100">Volatility 100</option>
<option value="R_75">Volatility 75</option>
<option value="R_50">Volatility 50</option>
</select>
<label>Trade Type:</label>
<select id="tradeType">
<option value="CALL">Rise</option>
<option value="PUT">Fall</option>
</select>
<label>Stake:</label><input id="stake" type="number" value="1">
<label>Confidence %:</label><input id="confidence" type="number" value="80">
<button onclick="handleTrade()">Trade Now</button>
<button onclick="toggleAuto()">Toggle Auto</button>
</div>
<div>
<h3>Trend & Analysis</h3>
<div id="analysis">Waiting for tick data...</div>
</div>
<h2>Trade History</h2>
<table>
<thead><tr><th>Index</th><th>Type</th><th>Stake</th><th>Result</th><th>Profit</th><th>Time</th></tr></thead>
<tbody id="history"></tbody>
</table>
</div>
<script>
let ws = null;
let auto = false;
let historyEl = document.getElementById('history');
let modeEl = document.getElementById('mode');
let analysisEl = document.getElementById('analysis');
let ticks = [];

modeEl.addEventListener('change', () => {
    document.getElementById('live-settings').style.display = modeEl.value === 'live' ? 'block' : 'none';
});

function connectDeriv(){
    const appId = document.getElementById('appId').value.trim();
    const token = document.getElementById('token').value.trim();
    ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${appId}`);
    ws.onopen = () => {
        ws.send(JSON.stringify({authorize: token}));
        subscribeTicks();
    };
    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if(data.msg_type === 'tick'){
            ticks.push(data.tick.quote);
            if(ticks.length > 100) ticks.shift();
            runAnalysis();
        }
        if(data.msg_type === 'authorize'){ console.log('Authorized'); }
        if(data.msg_type === 'proposal_open_contract' && data.proposal_open_contract.is_sold){
            const profit = data.proposal_open_contract.profit;
            addHistory(document.getElementById('index').value, document.getElementById('tradeType').value, document.getElementById('stake').value, profit > 0 ? 'Win' : 'Loss', profit.toFixed(2));
        }
    };
}

function subscribeTicks(){
    const symbol = document.getElementById('index').value;
    ws.send(JSON.stringify({ticks: symbol}));
}

function runAnalysis(){
    if(ticks.length < 50) return;
    const ema = (arr, period) => {
        const k = 2 / (period + 1);
        return arr.reduce((acc, val, i) => {
            if(i === 0) return [val];
            acc.push(val * k + acc[i-1] * (1 - k));
            return acc;
        }, []);
    };
    const ema20 = ema(ticks, 20);
    const ema50 = ema(ticks, 50);
    const trend = ema20.at(-1) > ema50.at(-1) ? 'Uptrend' : 'Downtrend';

    const rsi = () => {
        let gains = 0, losses = 0;
        for(let i=1; i<15; i++){
            const diff = ticks.at(-i) - ticks.at(-(i+1));
            if(diff > 0) gains += diff; else losses -= diff;
        }
        const rs = gains / (losses || 1);
        return 100 - (100 / (1 + rs));
    };
    const rsiVal = rsi().toFixed(2);

    const min = Math.min(...ticks);
    const max = Math.max(...ticks);
    const last = ticks.at(-1);
    const fibLevels = [0.236, 0.382, 0.5, 0.618, 0.786].map(l => max - (max-min)*l);
    const nearFib = fibLevels.some(f => Math.abs(f - last) / last < 0.001);

    let conf = 0;
    if(trend === 'Uptrend' && document.getElementById('tradeType').value === 'CALL') conf += 40;
    if(trend === 'Downtrend' && document.getElementById('tradeType').value === 'PUT') conf += 40;
    if((rsiVal < 30 && document.getElementById('tradeType').value === 'CALL') || (rsiVal > 70 && document.getElementById('tradeType').value === 'PUT')) conf += 40;
    if(nearFib) conf += 20;

    analysisEl.innerHTML = `Trend: ${trend} | RSI: ${rsiVal} | Near Fib: ${nearFib} | Confidence: ${conf}%<br>` +
        (conf >= document.getElementById('confidence').value ? '<span class="safe">Safe Entry</span>' : '<span class="unsafe">Unsafe</span>');
}

function handleTrade(){
    if(modeEl.value === 'simulation'){
        const conf = parseInt(document.getElementById('confidence').value);
        const win = Math.random()*100 <= conf;
        addHistory(document.getElementById('index').value, document.getElementById('tradeType').value, document.getElementById('stake').value, win ? 'Win' : 'Loss', win ? document.getElementById('stake').value : -document.getElementById('stake').value);
    } else {
        if(!ws || ws.readyState !== 1){ connectDeriv(); setTimeout(sendTrade, 1000); } else sendTrade();
    }
}

function sendTrade(){
    ws.send(JSON.stringify({
        buy: 1,
        price: document.getElementById('stake').value,
        parameters: {
            amount: document.getElementById('stake').value,
            basis: 'stake',
            contract_type: document.getElementById('tradeType').value,
            currency: 'USD',
            duration: 3,
            duration_unit: 't',
            symbol: document.getElementById('index').value
        }
    }));
}

function addHistory(index, type, stake, result, profit){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${index}</td><td>${type}</td><td>${stake}</td><td>${result}</td><td>${profit}</td><td>${new Date().toLocaleTimeString()}</td>`;
    historyEl.appendChild(tr);
}

function toggleAuto(){
    auto = !auto;
    if(auto) autoLoop();
}

function autoLoop(){
    if(auto){ handleTrade(); setTimeout(autoLoop, 4000); }
}
</script>
</body>
</html>
